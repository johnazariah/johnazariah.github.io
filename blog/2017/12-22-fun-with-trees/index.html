<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Fun With Trees</title>
    <meta name="description" />
    
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="alternate" href="https://johnazariah.github.io//rss.xml" title="John Azariah's Blog" type="application/rss+xml">
    <link rel="shortcut icon" href="https://johnazariah.github.io//favicon.png">

    <link rel="stylesheet" type="text/css" href="https://johnazariah.github.io//css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <!-- FSharp.Formatting Styles -->
    <link rel="stylesheet" type="text/css" media="screen" href="https://johnazariah.github.io//fsharp.formatting/tooltips.css" />
    <script type="text/javascript" src="https://johnazariah.github.io//fsharp.formatting/tooltips.js"></script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body class="post-template nav-closed">

    <div class="nav">
        
        <a class="subscribe-button icon-feed" href="https://johnazariah.github.io//rss.xml">Subscribe</a>
    </div>
    <span class="nav-cover"></span>

    <div class="site-wrapper">

        

<header class="main-header post-head no-cover">
    <nav class="main-nav clearfix">
        <a class="blog-logo" href="https://johnazariah.github.io/">Home</a>
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Fun With Trees</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2017-12-22T09:44:24">2017-12-22T09:44:24</time>
                   on trees; functional data structures; immutable; free monad
            </section>
        </header>

        <section class="post-content">
          
<h1>Monkeying Around : Fun with Trees</h1>
<h2>A Naive Solution</h2>
<p>Trees, like lists, are powerful, ubiquitous data structures. Also, like lists, they are recursively defined.</p>
<p>At first blush, a reasonable way of defining a tree might be:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">type</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span> {
    <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">Tag</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">a</span>
    <span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">Children</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs1', 4)" onmouseover="showTip(event, 'fs1', 4)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="t">list</span>
}
</code></pre></td>
</tr>
</table>
<p>This looks clean and elegant, but we immediately find it restrictive when we want to actually create a nested and branched structure. Unless we always build the tree up from the leaves towards the root, we need more sophisticated ways of walking the structure, and this leads to an interesting problem.</p>
<p>Specifically, if we need to introduce a reference to the parent of a given node, things get out of hand very quickly. This is the equivalent of trying to building a doubly-linked list with immutable data structures - which turns out to be a very difficult problem to solve.</p>
<p>This will not do.</p>
<h2>An Object Lesson</h2>
<p>But F# is a multi-paradigm language, and we can sacrifice immutability to get bi-directional links.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
<span class="l">50: </span>
<span class="l">51: </span>
<span class="l">52: </span>
<span class="l">53: </span>
<span class="l">54: </span>
<span class="l">55: </span>
<span class="l">56: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="t">Tree</span> <span class="o">=</span>
    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="t">NodeId</span> <span class="o">=</span> | <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="p">Id</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="t">string</span>

    [&lt;<span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="t">AutoOpen</span>&gt;]
    <span class="k">module</span> <span class="k">internal</span> <span class="t">Node</span> <span class="o">=</span>
        [&lt;<span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="t">AbstractClass</span>&gt;]
        <span class="k">type</span> <span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> () <span class="o">=</span> <span class="k">class</span>
            <span class="k">member</span> <span class="k">val</span> <span class="k">private</span> <span class="v">_children</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 13)" onmouseover="showTip(event, 'fs11', 13)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs4', 14)" onmouseover="showTip(event, 'fs4', 14)" class="t">list</span> <span class="o">=</span> [] <span class="k">with</span> <span class="i">get</span>, <span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">set</span> 
            <span class="k">member</span> <span class="k">internal</span> <span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 17)" onmouseover="showTip(event, 'fs14', 17)" class="i">Children</span> 
                <span class="k">with</span> <span class="i">get</span> () <span class="o">=</span> <span onmouseout="hideTip(event, 'fs13', 18)" onmouseover="showTip(event, 'fs13', 18)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 19)" onmouseover="showTip(event, 'fs15', 19)" class="i">_children</span>
                <span class="k">and</span>  <span onmouseout="hideTip(event, 'fs12', 20)" onmouseover="showTip(event, 'fs12', 20)" class="i">set</span> <span onmouseout="hideTip(event, 'fs16', 21)" onmouseover="showTip(event, 'fs16', 21)" class="i">ns</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs13', 22)" onmouseover="showTip(event, 'fs13', 22)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 23)" onmouseover="showTip(event, 'fs15', 23)" class="i">_children</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs16', 24)" onmouseover="showTip(event, 'fs16', 24)" class="i">ns</span>
            <span class="k">abstract</span> <span class="k">member</span> <span onmouseout="hideTip(event, 'fs17', 25)" onmouseover="showTip(event, 'fs17', 25)" class="i">Level</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs18', 26)" onmouseover="showTip(event, 'fs18', 26)" class="t">int</span>
        <span class="k">end</span>

        <span class="k">type</span> <span onmouseout="hideTip(event, 'fs19', 27)" onmouseover="showTip(event, 'fs19', 27)" class="t">Root</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> () <span class="o">=</span> <span class="k">class</span>
            <span class="k">inherit</span> <span onmouseout="hideTip(event, 'fs11', 28)" onmouseover="showTip(event, 'fs11', 28)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> ()
            <span class="k">override</span> <span onmouseout="hideTip(event, 'fs20', 29)" onmouseover="showTip(event, 'fs20', 29)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs21', 30)" onmouseover="showTip(event, 'fs21', 30)" class="i">Level</span> <span class="o">=</span> <span class="n">0</span>
        <span class="k">end</span>

        <span class="k">type</span> <span onmouseout="hideTip(event, 'fs22', 31)" onmouseover="showTip(event, 'fs22', 31)" class="t">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> (<span onmouseout="hideTip(event, 'fs23', 32)" onmouseover="showTip(event, 'fs23', 32)" class="i">id</span><span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 33)" onmouseover="showTip(event, 'fs6', 33)" class="t">NodeId</span>, <span onmouseout="hideTip(event, 'fs24', 34)" onmouseover="showTip(event, 'fs24', 34)" class="i">value</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 35)" onmouseover="showTip(event, 'fs25', 35)" class="t">option</span>, <span onmouseout="hideTip(event, 'fs26', 36)" onmouseover="showTip(event, 'fs26', 36)" class="i">parent</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 37)" onmouseover="showTip(event, 'fs11', 37)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>) <span class="o">=</span> <span class="k">class</span>
            <span class="k">inherit</span> <span onmouseout="hideTip(event, 'fs11', 38)" onmouseover="showTip(event, 'fs11', 38)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> ()
            <span class="k">member</span> <span onmouseout="hideTip(event, 'fs27', 39)" onmouseover="showTip(event, 'fs27', 39)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 40)" onmouseover="showTip(event, 'fs28', 40)" class="i">Id</span>     <span class="o">=</span> <span onmouseout="hideTip(event, 'fs23', 41)" onmouseover="showTip(event, 'fs23', 41)" class="i">id</span>
            <span class="k">member</span> <span onmouseout="hideTip(event, 'fs27', 42)" onmouseover="showTip(event, 'fs27', 42)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs29', 43)" onmouseover="showTip(event, 'fs29', 43)" class="i">Parent</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs26', 44)" onmouseover="showTip(event, 'fs26', 44)" class="i">parent</span>
            <span class="k">member</span> <span class="k">val</span> <span class="v">Value</span>   <span class="o">=</span> <span onmouseout="hideTip(event, 'fs24', 45)" onmouseover="showTip(event, 'fs24', 45)" class="v">value</span> <span class="k">with</span> <span class="i">get</span>, <span onmouseout="hideTip(event, 'fs12', 46)" onmouseover="showTip(event, 'fs12', 46)" class="i">set</span>
            <span class="k">override</span> <span onmouseout="hideTip(event, 'fs27', 47)" onmouseover="showTip(event, 'fs27', 47)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 48)" onmouseover="showTip(event, 'fs30', 48)" class="i">Level</span>  <span class="o">=</span> <span onmouseout="hideTip(event, 'fs26', 49)" onmouseover="showTip(event, 'fs26', 49)" class="i">parent</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs31', 50)" onmouseover="showTip(event, 'fs31', 50)" class="i">Level</span> <span class="o">+</span> <span class="n">1</span>

            <span class="k">override</span> <span onmouseout="hideTip(event, 'fs27', 51)" onmouseover="showTip(event, 'fs27', 51)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs32', 52)" onmouseover="showTip(event, 'fs32', 52)" class="f">ToString</span> () <span class="o">=</span>
                <span class="k">let</span> <span onmouseout="hideTip(event, 'fs33', 53)" onmouseover="showTip(event, 'fs33', 53)" class="i">value</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs27', 54)" onmouseover="showTip(event, 'fs27', 54)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 55)" onmouseover="showTip(event, 'fs34', 55)" class="i">Value</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs35', 56)" onmouseover="showTip(event, 'fs35', 56)" class="t">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs36', 57)" onmouseover="showTip(event, 'fs36', 57)" class="f">map</span> (<span onmouseout="hideTip(event, 'fs37', 58)" onmouseover="showTip(event, 'fs37', 58)" class="f">sprintf</span> <span class="s">&quot;</span><span class="pf">%A</span><span class="s">&quot;</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs35', 59)" onmouseover="showTip(event, 'fs35', 59)" class="i">Option</span><span class="o">.</span><span class="i">defaultValue</span> <span class="s">&quot;&quot;</span>
                <span onmouseout="hideTip(event, 'fs37', 60)" onmouseover="showTip(event, 'fs37', 60)" class="f">sprintf</span> <span class="s">&quot;&#39;</span><span class="pf">%s</span><span class="s">&#39; (</span><span class="pf">%A</span><span class="s">)&quot;</span> <span onmouseout="hideTip(event, 'fs23', 61)" onmouseover="showTip(event, 'fs23', 61)" class="i">id</span><span class="o">.</span><span class="i">unapply</span> <span onmouseout="hideTip(event, 'fs33', 62)" onmouseover="showTip(event, 'fs33', 62)" class="i">value</span>
        <span class="k">end</span>
       
    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs38', 63)" onmouseover="showTip(event, 'fs38', 63)" class="t">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> () <span class="o">=</span> <span class="k">class</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs39', 64)" onmouseover="showTip(event, 'fs39', 64)" class="i">root</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs19', 65)" onmouseover="showTip(event, 'fs19', 65)" class="t">Root</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> ()
        <span class="k">member</span> <span class="k">private</span> <span onmouseout="hideTip(event, 'fs40', 66)" onmouseover="showTip(event, 'fs40', 66)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs41', 67)" onmouseover="showTip(event, 'fs41', 67)" class="i">Root</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs39', 68)" onmouseover="showTip(event, 'fs39', 68)" class="i">root</span>
        <span class="k">member</span> <span class="k">val</span> <span class="k">private</span> <span onmouseout="hideTip(event, 'fs40', 69)" onmouseover="showTip(event, 'fs40', 69)" class="i">this</span><span class="o">.</span><span class="i">Current</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs39', 70)" onmouseover="showTip(event, 'fs39', 70)" class="i">root</span>

        <span class="c">// Modify the tag of the current node</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 71)" onmouseover="showTip(event, 'fs40', 71)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs42', 72)" onmouseover="showTip(event, 'fs42', 72)" class="i">ModifyValue</span> <span class="i">f</span>   <span class="o">=</span> <span class="o">..</span><span class="o">.</span>

        <span class="c">// Push a child on to the current node and make it the current node</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 73)" onmouseover="showTip(event, 'fs40', 73)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 74)" onmouseover="showTip(event, 'fs43', 74)" class="i">PushChild</span>  <span class="i">name</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>

        <span class="c">// Add a sibling to the current node and make it the current node</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 75)" onmouseover="showTip(event, 'fs40', 75)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs44', 76)" onmouseover="showTip(event, 'fs44', 76)" class="i">AddSibling</span> <span class="i">name</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>

        <span class="c">// Pop to the parent of this node and make it the current node</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 77)" onmouseover="showTip(event, 'fs40', 77)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 78)" onmouseover="showTip(event, 'fs45', 78)" class="i">Pop</span> <span class="i">l</span>           <span class="o">=</span> <span class="o">..</span><span class="o">.</span>

        <span class="c">// Other modification operations elided...</span>

        <span class="c">// Visit this tree in pre-order starting at the root</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 79)" onmouseover="showTip(event, 'fs40', 79)" class="i">this</span><span class="o">.</span><span class="i">VisitPreOrder</span> <span class="i">f</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>

        <span class="c">// Visit the path to the root from the current node</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 80)" onmouseover="showTip(event, 'fs40', 80)" class="i">this</span><span class="o">.</span><span class="i">VisitToRoot</span>   <span class="i">f</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>
    <span class="k">end</span>
</code></pre></td>
</tr>
</table>
<p>We note the following immediately:</p>
<ol>
<li>This is a familiar coding pattern. It's entirely conceivable that you would see similar code in C# or Java.</li>
<li>We are taking advantage of F#'s module system to encapsulate the <code>Node</code> and <code>Tree</code> data structures, hiding implementation details, and exposing just the operations we wish to provide</li>
<li>We are full-blown object-oriented and mutable at this point, so we are obliged to address several concerns that immutable data structures obviate.</li>
<li>The <code>Current</code> member is modified only whilst tree-building, and serves as the starting point for the <code>VisitToRoot</code> operation.</li>
<li><code>VisitPreOrder</code> and <code>VisitToRoot</code> must each have their own way of traversing the tree without modifying either <code>Root</code> or <code>Current</code>. Traversing the tree should necessarily be a read-only operation.</li>
</ol>
<p>This solution may suffice for some cases, but we're going to consider a situation where immutablity is actually something we need for the purposes of the domain. For example, let's say we're building the tree as part of an operation, and we want to ensure that the tree returns to its original state if that operation fails. Keeping track of the tree as it grows, and being able to roll-back to a given state, is not something that is pleasant to do correctly when mutability is in the picture - and doubly so when concurrency and mutability meet as part of the problem.</p>
<p>So we are faced with an interesting quandary - having the ability to <code>VisitToRoot</code> or <code>Pop</code> requires bi-directional linking - which is hard to do with immutable data structures; and having the ability to check-point and roll-back tree-modification operations is difficult to do correctly without immutable data structures! What do we do?</p>
<h2>Painting By Numbers</h2>
<p>What if, instead of actually creating and modifying a tree like we were taught in CS 101, we simply keep track of the list of tree-modification instructions as a kind of program? This list would have to support a limited form of mutability in that the only way to modify the list would be to append to it, but the existing contents of the list could never change.</p>
<p>When the tree needs to be visited, we take the list of instructions and interpret them to build a tree using the mutable approach, but since the contents of the list at this point is fixed, the tree that we create from it, is, in some sense, constant even though it contains mutable parts. Indeed, the only operations that the tree needs to support from that point on are (possibly repeated) traversals.</p>
<p>This approach is quite a powerful one, and can be applied to a variety of problems. We could, in fact, generalize the pattern completely in other languages that allow abstraction over types, and this forms the general principle behind what is known as the 'Free Monad'. However, since the concept is quite powerful, we are going to explore the concept concretely, and leave the abstraction of the pattern to Haskell and Scala programmers!</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">module</span> <span onmouseout="hideTip(event, 'fs38', 81)" onmouseover="showTip(event, 'fs38', 81)" class="i">Tree</span> <span class="o">=</span>
    <span class="c">// module Node elided ...</span>

    <span class="k">type</span> <span class="k">internal</span> <span class="i">ConstructOperation</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span>
    | <span class="i">PushChild</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 82)" onmouseover="showTip(event, 'fs6', 82)" class="i">NodeId</span> <span class="o">*</span> <span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 83)" onmouseover="showTip(event, 'fs25', 83)" class="i">option</span>
    | <span class="i">AddSibling</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 84)" onmouseover="showTip(event, 'fs6', 84)" class="i">NodeId</span> <span class="o">*</span> <span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 85)" onmouseover="showTip(event, 'fs25', 85)" class="i">option</span>
    | <span class="i">ModifyValue</span> <span class="k">of</span> (<span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 86)" onmouseover="showTip(event, 'fs25', 86)" class="i">option</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 87)" onmouseover="showTip(event, 'fs25', 87)" class="i">option</span>)
    | <span class="i">Pop</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs18', 88)" onmouseover="showTip(event, 'fs18', 88)" class="i">int</span> <span onmouseout="hideTip(event, 'fs25', 89)" onmouseover="showTip(event, 'fs25', 89)" class="i">option</span>

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs38', 90)" onmouseover="showTip(event, 'fs38', 90)" class="i">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> () <span class="o">=</span> <span class="k">class</span>
        <span class="k">member</span> <span class="k">val</span> <span class="k">private</span> <span class="v">ops</span> <span class="o">:</span> <span class="i">ConstructOperation</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span onmouseout="hideTip(event, 'fs4', 91)" onmouseover="showTip(event, 'fs4', 91)" class="t">list</span> <span class="o">=</span> [] <span class="k">with</span> <span class="i">get</span>, <span onmouseout="hideTip(event, 'fs12', 92)" onmouseover="showTip(event, 'fs12', 92)" class="i">set</span>

        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 93)" onmouseover="showTip(event, 'fs40', 93)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs46', 94)" onmouseover="showTip(event, 'fs46', 94)" class="f">PushChild</span>    <span onmouseout="hideTip(event, 'fs47', 95)" onmouseover="showTip(event, 'fs47', 95)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs40', 96)" onmouseover="showTip(event, 'fs40', 96)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 97)" onmouseover="showTip(event, 'fs48', 97)" class="i">ops</span> <span class="o">&lt;-</span> <span class="i">PushChild</span>              <span onmouseout="hideTip(event, 'fs47', 98)" onmouseover="showTip(event, 'fs47', 98)" class="i">x</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs40', 99)" onmouseover="showTip(event, 'fs40', 99)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 100)" onmouseover="showTip(event, 'fs48', 100)" class="i">ops</span>; <span onmouseout="hideTip(event, 'fs40', 101)" onmouseover="showTip(event, 'fs40', 101)" class="i">this</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 102)" onmouseover="showTip(event, 'fs40', 102)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 103)" onmouseover="showTip(event, 'fs49', 103)" class="f">AddSibling</span>   <span onmouseout="hideTip(event, 'fs47', 104)" onmouseover="showTip(event, 'fs47', 104)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs40', 105)" onmouseover="showTip(event, 'fs40', 105)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 106)" onmouseover="showTip(event, 'fs48', 106)" class="i">ops</span> <span class="o">&lt;-</span> <span class="i">AddSibling</span>             <span onmouseout="hideTip(event, 'fs47', 107)" onmouseover="showTip(event, 'fs47', 107)" class="i">x</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs40', 108)" onmouseover="showTip(event, 'fs40', 108)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 109)" onmouseover="showTip(event, 'fs48', 109)" class="i">ops</span>; <span onmouseout="hideTip(event, 'fs40', 110)" onmouseover="showTip(event, 'fs40', 110)" class="i">this</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 111)" onmouseover="showTip(event, 'fs40', 111)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs50', 112)" onmouseover="showTip(event, 'fs50', 112)" class="f">ModifyValue</span>  <span onmouseout="hideTip(event, 'fs47', 113)" onmouseover="showTip(event, 'fs47', 113)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs40', 114)" onmouseover="showTip(event, 'fs40', 114)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 115)" onmouseover="showTip(event, 'fs48', 115)" class="i">ops</span> <span class="o">&lt;-</span> <span class="i">ModifyValue</span>            <span onmouseout="hideTip(event, 'fs47', 116)" onmouseover="showTip(event, 'fs47', 116)" class="i">x</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs40', 117)" onmouseover="showTip(event, 'fs40', 117)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 118)" onmouseover="showTip(event, 'fs48', 118)" class="i">ops</span>; <span onmouseout="hideTip(event, 'fs40', 119)" onmouseover="showTip(event, 'fs40', 119)" class="i">this</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs40', 120)" onmouseover="showTip(event, 'fs40', 120)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 121)" onmouseover="showTip(event, 'fs51', 121)" class="f">Pop</span>         <span class="o">?</span><span onmouseout="hideTip(event, 'fs52', 122)" onmouseover="showTip(event, 'fs52', 122)" class="i">x</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs40', 123)" onmouseover="showTip(event, 'fs40', 123)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 124)" onmouseover="showTip(event, 'fs48', 124)" class="i">ops</span> <span class="o">&lt;-</span> <span class="i">ConstructOperation</span><span class="o">.</span><span class="i">Pop</span> <span onmouseout="hideTip(event, 'fs52', 125)" onmouseover="showTip(event, 'fs52', 125)" class="i">x</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs40', 126)" onmouseover="showTip(event, 'fs40', 126)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs48', 127)" onmouseover="showTip(event, 'fs48', 127)" class="i">ops</span>; <span onmouseout="hideTip(event, 'fs40', 128)" onmouseover="showTip(event, 'fs40', 128)" class="i">this</span>
    <span class="k">end</span>
</code></pre></td>
</tr>
</table>
<p>Of course, this is all well and good to build up a list of operations, but this doesn't actually build a tree - and we aren't really able to traverse the tree in any meaningful way.</p>
<p>One sneaky thing we have done is to build the list in reverse. This ensures that each operation is processed in constant-time.</p>
<p>In order to build the tree, we start with a single node, and fold over the list processing each node in turn. We want the result of the fold to be the tree with bi-directional links.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs53', 129)" onmouseover="showTip(event, 'fs53', 129)" class="f">applyOp</span> <span onmouseout="hideTip(event, 'fs54', 130)" onmouseover="showTip(event, 'fs54', 130)" class="i">op</span> (<span onmouseout="hideTip(event, 'fs55', 131)" onmouseover="showTip(event, 'fs55', 131)" class="i">node</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 132)" onmouseover="showTip(event, 'fs11', 132)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>)  <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 133)" onmouseover="showTip(event, 'fs11', 133)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span> 
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs54', 134)" onmouseover="showTip(event, 'fs54', 134)" class="i">op</span> <span class="k">with</span>

        <span class="c">// Push a child on to the given node and return it        </span>
        | <span class="i">PushChild</span> (<span class="i">x</span>, <span class="i">v</span>) <span class="k">-&gt;</span> 
            <span class="k">let</span> <span class="i">child</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs56', 135)" onmouseover="showTip(event, 'fs56', 135)" class="i">Node</span> (<span class="i">x</span>, <span class="i">v</span>, <span onmouseout="hideTip(event, 'fs55', 136)" onmouseover="showTip(event, 'fs55', 136)" class="i">node</span>)
            <span onmouseout="hideTip(event, 'fs55', 137)" onmouseover="showTip(event, 'fs55', 137)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs57', 138)" onmouseover="showTip(event, 'fs57', 138)" class="i">Children</span> <span class="o">&lt;-</span> <span class="k">upcast</span> <span class="i">child</span> <span class="o">::</span> <span onmouseout="hideTip(event, 'fs55', 139)" onmouseover="showTip(event, 'fs55', 139)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs57', 140)" onmouseover="showTip(event, 'fs57', 140)" class="i">Children</span>
            <span class="k">upcast</span> <span class="i">child</span>

        <span class="c">// Add a sibling to the given node and return it</span>
        | <span class="i">AddSibling</span> (<span class="i">x</span>, <span class="i">v</span>) <span class="k">-&gt;</span>
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs55', 141)" onmouseover="showTip(event, 'fs55', 141)" class="i">node</span> <span class="k">with</span>
            | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 142)" onmouseover="showTip(event, 'fs56', 142)" class="i">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span class="i">n</span> <span class="k">-&gt;</span>
                <span class="k">let</span> <span class="i">sibling</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs56', 143)" onmouseover="showTip(event, 'fs56', 143)" class="i">Node</span>(<span class="i">x</span>, <span class="i">v</span>, <span class="i">n</span><span class="o">.</span><span class="i">Parent</span>)
                <span class="i">n</span><span class="o">.</span><span class="i">Parent</span><span class="o">.</span><span class="i">Children</span> <span class="o">&lt;-</span> <span class="k">upcast</span> <span class="i">sibling</span> <span class="o">::</span> <span class="i">n</span><span class="o">.</span><span class="i">Parent</span><span class="o">.</span><span class="i">Children</span>
                <span class="k">upcast</span> <span class="i">sibling</span>
            | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs58', 144)" onmouseover="showTip(event, 'fs58', 144)" class="i">failwith</span> <span class="s">&quot;Cannot add sibling to root&quot;</span>

        <span class="c">// Modify the tag of the given node and return it</span>
        | <span class="i">ModifyValue</span> <span class="i">f</span> <span class="k">-&gt;</span> 
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs55', 145)" onmouseover="showTip(event, 'fs55', 145)" class="i">node</span> <span class="k">with</span>
            | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 146)" onmouseover="showTip(event, 'fs56', 146)" class="i">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span class="i">n</span> <span class="k">-&gt;</span>
                <span class="i">n</span><span class="o">.</span><span class="i">Value</span> <span class="o">&lt;-</span> <span class="i">f</span> <span class="i">n</span><span class="o">.</span><span class="i">Value</span>
                <span class="k">upcast</span> <span class="i">n</span>
            | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs58', 147)" onmouseover="showTip(event, 'fs58', 147)" class="i">failwith</span> <span class="s">&quot;Cannot modify value of root&quot;</span>

        <span class="c">// Pop (recursively) to an ancestor of this node and return it</span>
        | <span class="i">ConstructOperation</span><span class="o">.</span><span class="i">Pop</span> <span class="i">l</span> <span class="k">-&gt;</span>
            <span class="k">match</span> <span onmouseout="hideTip(event, 'fs55', 148)" onmouseover="showTip(event, 'fs55', 148)" class="i">node</span> <span class="k">with</span>
            | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 149)" onmouseover="showTip(event, 'fs56', 149)" class="i">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span class="i">n</span> <span class="k">-&gt;</span> 
                <span class="k">let</span> <span class="i">level</span> <span class="o">=</span> <span class="i">l</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs35', 150)" onmouseover="showTip(event, 'fs35', 150)" class="i">Option</span><span class="o">.</span><span class="i">defaultValue</span> (<span class="i">n</span><span class="o">.</span><span class="i">Level</span> <span class="o">-</span> <span class="n">1</span>)
                <span class="k">if</span> (<span class="i">n</span><span class="o">.</span><span class="i">Parent</span><span class="o">.</span><span class="i">Level</span> <span class="o">=</span> <span class="i">level</span>) <span class="k">then</span>
                    <span class="i">n</span><span class="o">.</span><span class="i">Parent</span>
                <span class="k">elif</span> (<span class="i">n</span><span class="o">.</span><span class="i">Level</span> <span class="o">&gt;</span> <span class="i">level</span>) <span class="k">then</span>
                    <span onmouseout="hideTip(event, 'fs53', 151)" onmouseover="showTip(event, 'fs53', 151)" class="i">applyOp</span> (<span class="i">ConstructOperation</span><span class="o">.</span><span class="i">Pop</span> (<span onmouseout="hideTip(event, 'fs59', 152)" onmouseover="showTip(event, 'fs59', 152)" class="i">Some</span> <span class="i">level</span>)) (<span class="i">n</span><span class="o">.</span><span class="i">Parent</span>)
                <span class="k">else</span>
                    <span onmouseout="hideTip(event, 'fs58', 153)" onmouseover="showTip(event, 'fs58', 153)" class="i">failwith</span> <span class="s">&quot;How did we get here?&quot;</span>

            | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs58', 154)" onmouseover="showTip(event, 'fs58', 154)" class="i">failwith</span> <span class="s">&quot;Cannot pop root&quot;</span>
</code></pre></td>
</tr>
</table>
<p>This function takes an operation <code>op</code> and applies it to a given node, returning a result. The signature of the function has been chosen to align with one of the folding functions, so if we start with a list of operations and a root node, we should be able to build up a full tree from the list, and end up pointing to the <em>current</em> node.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs60', 155)" onmouseover="showTip(event, 'fs60', 155)" class="i">current</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs61', 156)" onmouseover="showTip(event, 'fs61', 156)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs62', 157)" onmouseover="showTip(event, 'fs62', 157)" class="f">foldBack</span> <span onmouseout="hideTip(event, 'fs53', 158)" onmouseover="showTip(event, 'fs53', 158)" class="f">applyOp</span> <span class="i">ops</span> (<span class="k">upcast</span> (<span onmouseout="hideTip(event, 'fs19', 159)" onmouseover="showTip(event, 'fs19', 159)" class="t">Root</span>()))
</code></pre></td>
</tr>
</table>
<p>Of course, we will want to also have a handle to the root of the tree, so we can do traversals like a pre-order walk. We can get that by recursively walking up from the current position until we hit a root node.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs63', 160)" onmouseover="showTip(event, 'fs63', 160)" class="f">visitRoot</span> <span onmouseout="hideTip(event, 'fs64', 161)" onmouseover="showTip(event, 'fs64', 161)" class="i">start</span> <span class="o">=</span> 
            <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs65', 162)" onmouseover="showTip(event, 'fs65', 162)" class="f">visit</span> (<span onmouseout="hideTip(event, 'fs55', 163)" onmouseover="showTip(event, 'fs55', 163)" class="i">node</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 164)" onmouseover="showTip(event, 'fs11', 164)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>) <span class="o">=</span>
                <span class="k">match</span> <span onmouseout="hideTip(event, 'fs55', 165)" onmouseover="showTip(event, 'fs55', 165)" class="i">node</span> <span class="k">with</span>
                | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 166)" onmouseover="showTip(event, 'fs56', 166)" class="t">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span onmouseout="hideTip(event, 'fs66', 167)" onmouseover="showTip(event, 'fs66', 167)" class="i">n</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs67', 168)" onmouseover="showTip(event, 'fs67', 168)" class="i">seq</span> {
                        <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs55', 169)" onmouseover="showTip(event, 'fs55', 169)" class="i">node</span>
                        <span class="k">yield!</span> <span onmouseout="hideTip(event, 'fs65', 170)" onmouseover="showTip(event, 'fs65', 170)" class="f">visit</span> <span onmouseout="hideTip(event, 'fs66', 171)" onmouseover="showTip(event, 'fs66', 171)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs68', 172)" onmouseover="showTip(event, 'fs68', 172)" class="i">Parent</span>
                    }
                | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs19', 173)" onmouseover="showTip(event, 'fs19', 173)" class="t">Root</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span onmouseout="hideTip(event, 'fs69', 174)" onmouseover="showTip(event, 'fs69', 174)" class="i">r</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs67', 175)" onmouseover="showTip(event, 'fs67', 175)" class="i">seq</span> { <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs55', 176)" onmouseover="showTip(event, 'fs55', 176)" class="i">node</span> }
                | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs70', 177)" onmouseover="showTip(event, 'fs70', 177)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs71', 178)" onmouseover="showTip(event, 'fs71', 178)" class="i">empty</span>
            <span onmouseout="hideTip(event, 'fs65', 179)" onmouseover="showTip(event, 'fs65', 179)" class="f">visit</span> <span onmouseout="hideTip(event, 'fs64', 180)" onmouseover="showTip(event, 'fs64', 180)" class="i">start</span>

        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs72', 181)" onmouseover="showTip(event, 'fs72', 181)" class="i">last</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs63', 182)" onmouseover="showTip(event, 'fs63', 182)" class="f">visitRoot</span> <span onmouseout="hideTip(event, 'fs60', 183)" onmouseover="showTip(event, 'fs60', 183)" class="i">current</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs70', 184)" onmouseover="showTip(event, 'fs70', 184)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs73', 185)" onmouseover="showTip(event, 'fs73', 185)" class="f">last</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs39', 186)" onmouseover="showTip(event, 'fs39', 186)" class="i">root</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs72', 187)" onmouseover="showTip(event, 'fs72', 187)" class="i">last</span> <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs19', 188)" onmouseover="showTip(event, 'fs19', 188)" class="t">Root</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>
</code></pre></td>
</tr>
</table>
<p>Now, since we have started with a fixed list of operations, the <code>current</code> and <code>root</code> values represent a fixed tree. We can keep this pair in a structure that represents the "tree" version of the operations/</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs38', 189)" onmouseover="showTip(event, 'fs38', 189)" class="i">Tree</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> () <span class="o">=</span> <span class="k">class</span>
        <span class="c">// other members elided...</span>
        <span class="k">member</span> <span class="i">this</span><span class="o">.</span><span class="i">Build</span> () <span class="o">=</span> <span class="i">TreeCursor</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> (<span class="i">this</span><span class="o">.</span><span class="i">ops</span>)
    <span class="k">end</span>

    <span class="k">and</span> <span class="i">TreeCursor</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">internal</span> (<span class="i">ops</span>) <span class="o">=</span> <span class="k">class</span>
        <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs53', 190)" onmouseover="showTip(event, 'fs53', 190)" class="i">applyOp</span> <span onmouseout="hideTip(event, 'fs54', 191)" onmouseover="showTip(event, 'fs54', 191)" class="i">op</span> (<span onmouseout="hideTip(event, 'fs55', 192)" onmouseover="showTip(event, 'fs55', 192)" class="i">node</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 193)" onmouseover="showTip(event, 'fs11', 193)" class="i">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>)  <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 194)" onmouseover="showTip(event, 'fs11', 194)" class="i">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs60', 195)" onmouseover="showTip(event, 'fs60', 195)" class="i">current</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs61', 196)" onmouseover="showTip(event, 'fs61', 196)" class="i">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs62', 197)" onmouseover="showTip(event, 'fs62', 197)" class="i">foldBack</span> <span onmouseout="hideTip(event, 'fs53', 198)" onmouseover="showTip(event, 'fs53', 198)" class="i">applyOp</span> <span class="i">ops</span> (<span class="k">upcast</span> (<span onmouseout="hideTip(event, 'fs19', 199)" onmouseover="showTip(event, 'fs19', 199)" class="i">Root</span>()))
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs63', 200)" onmouseover="showTip(event, 'fs63', 200)" class="i">visitRoot</span> <span class="i">start</span> <span class="o">=</span> <span class="o">..</span><span class="o">.</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs72', 201)" onmouseover="showTip(event, 'fs72', 201)" class="i">last</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs63', 202)" onmouseover="showTip(event, 'fs63', 202)" class="i">visitRoot</span> <span onmouseout="hideTip(event, 'fs60', 203)" onmouseover="showTip(event, 'fs60', 203)" class="i">current</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs70', 204)" onmouseover="showTip(event, 'fs70', 204)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs73', 205)" onmouseover="showTip(event, 'fs73', 205)" class="i">last</span> 
        <span class="k">let</span> <span class="i">root</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs72', 206)" onmouseover="showTip(event, 'fs72', 206)" class="i">last</span> <span class="o">:?&gt;</span> <span onmouseout="hideTip(event, 'fs19', 207)" onmouseover="showTip(event, 'fs19', 207)" class="i">Root</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>
    <span class="k">end</span>
</code></pre></td>
</tr>
</table>
<p>While it might seem like a good idea to use a record for this, it might be better to use a class instead, because we don't want to expose the actual <code>current</code> and <code>root</code> members.</p>
<p>In fact, by using appropriate privacy modifiers on the constructor, we can make both the <code>Tree&lt;'a&gt;</code> and <code>TreeCursor&lt;'a&gt;</code> classes totally opaque - hiding the entire data structures within and only providing a clean programmatic interface to them.</p>
<p>Also, since a <code>TreeCursor</code> instance represents a <code>Tree</code> fixed at a given point, the only meaningful thing we can do to a <code>TreeCursor</code> is to traverse it, which leads to a very interesting observation. Since the tree is fixed, its traversals are <em>also</em> fixed. Which means we only have to traverse it once and build up a list of things we saw in the traversal, and then we can play back the traversal operations and process the tree in any way we choose.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs74', 208)" onmouseover="showTip(event, 'fs74', 208)" class="t">VisitOperation</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="o">=</span>
        | <span onmouseout="hideTip(event, 'fs75', 209)" onmouseover="showTip(event, 'fs75', 209)" class="p">VisitRoot</span>
        | <span onmouseout="hideTip(event, 'fs76', 210)" onmouseover="showTip(event, 'fs76', 210)" class="p">VisitChild</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 211)" onmouseover="showTip(event, 'fs6', 211)" class="t">NodeId</span>
        | <span onmouseout="hideTip(event, 'fs77', 212)" onmouseover="showTip(event, 'fs77', 212)" class="p">ReadValue</span>  <span class="k">of</span> <span onmouseout="hideTip(event, 'fs6', 213)" onmouseover="showTip(event, 'fs6', 213)" class="t">NodeId</span> <span class="o">*</span> <span class="o">&#39;</span><span class="i">a</span> <span onmouseout="hideTip(event, 'fs25', 214)" onmouseover="showTip(event, 'fs25', 214)" class="t">option</span>
        | <span onmouseout="hideTip(event, 'fs78', 215)" onmouseover="showTip(event, 'fs78', 215)" class="p">Pop</span>

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs79', 216)" onmouseover="showTip(event, 'fs79', 216)" class="t">TreeCursor</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">internal</span> (<span onmouseout="hideTip(event, 'fs80', 217)" onmouseover="showTip(event, 'fs80', 217)" class="i">ops</span>) <span class="o">=</span> <span class="k">class</span>
        <span class="c">// other members elided...</span>

        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs81', 218)" onmouseover="showTip(event, 'fs81', 218)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs82', 219)" onmouseover="showTip(event, 'fs82', 219)" class="i">PathToRoot</span> <span class="o">=</span> 
            <span class="k">let</span> <span onmouseout="hideTip(event, 'fs83', 220)" onmouseover="showTip(event, 'fs83', 220)" class="f">readValue</span> (<span onmouseout="hideTip(event, 'fs84', 221)" onmouseover="showTip(event, 'fs84', 221)" class="i">nb</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 222)" onmouseover="showTip(event, 'fs11', 222)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>) <span class="o">=</span> 
                <span class="k">match</span> <span onmouseout="hideTip(event, 'fs84', 223)" onmouseover="showTip(event, 'fs84', 223)" class="i">nb</span> <span class="k">with</span>
                | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 224)" onmouseover="showTip(event, 'fs56', 224)" class="t">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span onmouseout="hideTip(event, 'fs66', 225)" onmouseover="showTip(event, 'fs66', 225)" class="i">n</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs77', 226)" onmouseover="showTip(event, 'fs77', 226)" class="p">ReadValue</span> (<span onmouseout="hideTip(event, 'fs66', 227)" onmouseover="showTip(event, 'fs66', 227)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs85', 228)" onmouseover="showTip(event, 'fs85', 228)" class="i">Id</span>, <span onmouseout="hideTip(event, 'fs66', 229)" onmouseover="showTip(event, 'fs66', 229)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 230)" onmouseover="showTip(event, 'fs34', 230)" class="i">Value</span>)
                | _ <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs75', 231)" onmouseover="showTip(event, 'fs75', 231)" class="p">VisitRoot</span> 
            <span class="i">visitRoot</span> <span class="i">current</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs70', 232)" onmouseover="showTip(event, 'fs70', 232)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs86', 233)" onmouseover="showTip(event, 'fs86', 233)" class="f">map</span> <span onmouseout="hideTip(event, 'fs83', 234)" onmouseover="showTip(event, 'fs83', 234)" class="f">readValue</span>
        
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs81', 235)" onmouseover="showTip(event, 'fs81', 235)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs87', 236)" onmouseover="showTip(event, 'fs87', 236)" class="i">PreOrderPath</span> <span class="o">=</span>
            <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs88', 237)" onmouseover="showTip(event, 'fs88', 237)" class="f">visit</span> (<span onmouseout="hideTip(event, 'fs55', 238)" onmouseover="showTip(event, 'fs55', 238)" class="i">node</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs11', 239)" onmouseover="showTip(event, 'fs11', 239)" class="t">NodeBase</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span>) <span class="o">=</span>
                <span onmouseout="hideTip(event, 'fs67', 240)" onmouseover="showTip(event, 'fs67', 240)" class="i">seq</span> {
                    <span class="k">match</span> <span onmouseout="hideTip(event, 'fs55', 241)" onmouseover="showTip(event, 'fs55', 241)" class="i">node</span> <span class="k">with</span>
                    | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 242)" onmouseover="showTip(event, 'fs56', 242)" class="t">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span onmouseout="hideTip(event, 'fs66', 243)" onmouseover="showTip(event, 'fs66', 243)" class="i">n</span> <span class="k">-&gt;</span> <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs77', 244)" onmouseover="showTip(event, 'fs77', 244)" class="p">ReadValue</span> (<span onmouseout="hideTip(event, 'fs66', 245)" onmouseover="showTip(event, 'fs66', 245)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs85', 246)" onmouseover="showTip(event, 'fs85', 246)" class="i">Id</span>, <span onmouseout="hideTip(event, 'fs66', 247)" onmouseover="showTip(event, 'fs66', 247)" class="i">n</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs34', 248)" onmouseover="showTip(event, 'fs34', 248)" class="i">Value</span>)
                    | _ <span class="k">-&gt;</span> <span class="k">yield!</span> <span onmouseout="hideTip(event, 'fs70', 249)" onmouseover="showTip(event, 'fs70', 249)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs71', 250)" onmouseover="showTip(event, 'fs71', 250)" class="i">empty</span>

                    <span class="k">for</span> <span onmouseout="hideTip(event, 'fs89', 251)" onmouseover="showTip(event, 'fs89', 251)" class="i">child</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs55', 252)" onmouseover="showTip(event, 'fs55', 252)" class="i">node</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs57', 253)" onmouseover="showTip(event, 'fs57', 253)" class="i">Children</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs61', 254)" onmouseover="showTip(event, 'fs61', 254)" class="t">List</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs90', 255)" onmouseover="showTip(event, 'fs90', 255)" class="f">rev</span> <span class="k">do</span>
                        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs89', 256)" onmouseover="showTip(event, 'fs89', 256)" class="i">child</span> <span class="k">with</span>
                        | <span class="o">:?</span> <span onmouseout="hideTip(event, 'fs56', 257)" onmouseover="showTip(event, 'fs56', 257)" class="t">Node</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">as</span> <span onmouseout="hideTip(event, 'fs91', 258)" onmouseover="showTip(event, 'fs91', 258)" class="i">c</span> <span class="k">-&gt;</span> 
                            <span class="k">yield!</span> <span onmouseout="hideTip(event, 'fs67', 259)" onmouseover="showTip(event, 'fs67', 259)" class="i">seq</span> {
                                <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs76', 260)" onmouseover="showTip(event, 'fs76', 260)" class="p">VisitChild</span> <span onmouseout="hideTip(event, 'fs91', 261)" onmouseover="showTip(event, 'fs91', 261)" class="i">c</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs85', 262)" onmouseover="showTip(event, 'fs85', 262)" class="i">Id</span>
                                <span class="k">yield!</span> <span onmouseout="hideTip(event, 'fs88', 263)" onmouseover="showTip(event, 'fs88', 263)" class="f">visit</span> <span onmouseout="hideTip(event, 'fs89', 264)" onmouseover="showTip(event, 'fs89', 264)" class="i">child</span>
                                <span class="k">yield</span> <span onmouseout="hideTip(event, 'fs74', 265)" onmouseover="showTip(event, 'fs74', 265)" class="t">VisitOperation</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 266)" onmouseover="showTip(event, 'fs78', 266)" class="p">Pop</span>
                            }
                        | _ <span class="k">-&gt;</span> <span class="k">yield!</span> <span onmouseout="hideTip(event, 'fs70', 267)" onmouseover="showTip(event, 'fs70', 267)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs71', 268)" onmouseover="showTip(event, 'fs71', 268)" class="i">empty</span>
                }
            <span onmouseout="hideTip(event, 'fs88', 269)" onmouseover="showTip(event, 'fs88', 269)" class="f">visit</span> <span class="i">root</span>
    <span class="k">end</span>
</code></pre></td>
</tr>
</table>
<p>In the code snippet above, we have defined two interesting traversals - one starts at the current node and walks back to the root, and the other starts at the root and traverses the whole tree "pre-order".</p>
<p>Each traversal results in a fixed sequence of <code>VisitOperation&lt;'a&gt;</code> for future use.</p>
<p>Tree traversals are best represented as folds. This is actually a much broader topic of discussion, but folding over trees can build all kinds of other data structures - including other trees, and allow for tree-rewriting.</p>
<p>In our case, we can traverse the tree, and then fold over it, as follows:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs79', 270)" onmouseover="showTip(event, 'fs79', 270)" class="i">TreeCursor</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">internal</span> (<span onmouseout="hideTip(event, 'fs80', 271)" onmouseover="showTip(event, 'fs80', 271)" class="i">ops</span>) <span class="o">=</span> <span class="k">class</span>
        <span class="c">// other members elided...</span>
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs81', 272)" onmouseover="showTip(event, 'fs81', 272)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs75', 273)" onmouseover="showTip(event, 'fs75', 273)" class="i">VisitRoot</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">o</span><span class="o">&gt;</span>     (<span class="i">processor</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">o</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs74', 274)" onmouseover="showTip(event, 'fs74', 274)" class="i">VisitOperation</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">o</span>) (<span class="i">seed</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">o</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs70', 275)" onmouseover="showTip(event, 'fs70', 275)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs92', 276)" onmouseover="showTip(event, 'fs92', 276)" class="i">fold</span> <span class="i">processor</span> <span class="i">seed</span> <span onmouseout="hideTip(event, 'fs81', 277)" onmouseover="showTip(event, 'fs81', 277)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs93', 278)" onmouseover="showTip(event, 'fs93', 278)" class="i">PathToRoot</span> 
        <span class="k">member</span> <span onmouseout="hideTip(event, 'fs81', 279)" onmouseover="showTip(event, 'fs81', 279)" class="i">this</span><span class="o">.</span><span class="i">VisitPreOrder</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">o</span><span class="o">&gt;</span> (<span class="i">processor</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">o</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs74', 280)" onmouseover="showTip(event, 'fs74', 280)" class="i">VisitOperation</span><span class="o">&lt;</span><span class="o">&#39;</span><span class="i">a</span><span class="o">&gt;</span> <span class="k">-&gt;</span> <span class="o">&#39;</span><span class="i">o</span>) (<span class="i">seed</span> <span class="o">:</span> <span class="o">&#39;</span><span class="i">o</span>) <span class="o">=</span> <span onmouseout="hideTip(event, 'fs70', 281)" onmouseover="showTip(event, 'fs70', 281)" class="i">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs92', 282)" onmouseover="showTip(event, 'fs92', 282)" class="i">fold</span> <span class="i">processor</span> <span class="i">seed</span> <span onmouseout="hideTip(event, 'fs81', 283)" onmouseover="showTip(event, 'fs81', 283)" class="i">this</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs94', 284)" onmouseover="showTip(event, 'fs94', 284)" class="i">PreOrderPath</span>
    <span class="k">end</span>
</code></pre></td>
</tr>
</table>
<p>And there we have it.</p>
<p>We have implemented a traditional tree which affords the benefits of immutable data structures (like check-pointing), whilst allowing for efficient tree traversals using parent-pointers, and functionally separating out the traversal concerns from the tree-node processing concerns.</p>
<p>And in less than 150 lines of code!</p>
<h2>Soup's Up!</h2>
<p>Let's build an example to see how this can be used:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 285)" onmouseover="showTip(event, 'fs95', 285)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs38', 286)" onmouseover="showTip(event, 'fs38', 286)" class="t">Tree</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs8', 287)" onmouseover="showTip(event, 'fs8', 287)" class="t">string</span><span class="o">&gt;</span> ()

    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 288)" onmouseover="showTip(event, 'fs95', 288)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 289)" onmouseover="showTip(event, 'fs95', 289)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 290)" onmouseover="showTip(event, 'fs43', 290)" class="f">PushChild</span> (<span onmouseout="hideTip(event, 'fs7', 291)" onmouseover="showTip(event, 'fs7', 291)" class="p">Id</span> <span class="s">&quot;a&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 292)" onmouseover="showTip(event, 'fs96', 292)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 293)" onmouseover="showTip(event, 'fs95', 293)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 294)" onmouseover="showTip(event, 'fs95', 294)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 295)" onmouseover="showTip(event, 'fs43', 295)" class="f">PushChild</span> (<span onmouseout="hideTip(event, 'fs7', 296)" onmouseover="showTip(event, 'fs7', 296)" class="p">Id</span> <span class="s">&quot;b&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 297)" onmouseover="showTip(event, 'fs96', 297)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 298)" onmouseover="showTip(event, 'fs95', 298)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 299)" onmouseover="showTip(event, 'fs95', 299)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 300)" onmouseover="showTip(event, 'fs43', 300)" class="f">PushChild</span> (<span onmouseout="hideTip(event, 'fs7', 301)" onmouseover="showTip(event, 'fs7', 301)" class="p">Id</span> <span class="s">&quot;b1&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 302)" onmouseover="showTip(event, 'fs96', 302)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 303)" onmouseover="showTip(event, 'fs95', 303)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 304)" onmouseover="showTip(event, 'fs95', 304)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs44', 305)" onmouseover="showTip(event, 'fs44', 305)" class="f">AddSibling</span> (<span onmouseout="hideTip(event, 'fs7', 306)" onmouseover="showTip(event, 'fs7', 306)" class="p">Id</span> <span class="s">&quot;b2&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 307)" onmouseover="showTip(event, 'fs96', 307)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 308)" onmouseover="showTip(event, 'fs95', 308)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 309)" onmouseover="showTip(event, 'fs95', 309)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 310)" onmouseover="showTip(event, 'fs45', 310)" class="f">Pop</span> ()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 311)" onmouseover="showTip(event, 'fs95', 311)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 312)" onmouseover="showTip(event, 'fs95', 312)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs44', 313)" onmouseover="showTip(event, 'fs44', 313)" class="f">AddSibling</span> (<span onmouseout="hideTip(event, 'fs7', 314)" onmouseover="showTip(event, 'fs7', 314)" class="p">Id</span> <span class="s">&quot;c&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 315)" onmouseover="showTip(event, 'fs96', 315)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 316)" onmouseover="showTip(event, 'fs95', 316)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 317)" onmouseover="showTip(event, 'fs95', 317)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 318)" onmouseover="showTip(event, 'fs43', 318)" class="f">PushChild</span> (<span onmouseout="hideTip(event, 'fs7', 319)" onmouseover="showTip(event, 'fs7', 319)" class="p">Id</span> <span class="s">&quot;c1&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 320)" onmouseover="showTip(event, 'fs96', 320)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 321)" onmouseover="showTip(event, 'fs95', 321)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 322)" onmouseover="showTip(event, 'fs95', 322)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs44', 323)" onmouseover="showTip(event, 'fs44', 323)" class="f">AddSibling</span> (<span onmouseout="hideTip(event, 'fs7', 324)" onmouseover="showTip(event, 'fs7', 324)" class="p">Id</span> <span class="s">&quot;c2&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 325)" onmouseover="showTip(event, 'fs96', 325)" class="p">None</span>)
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 326)" onmouseover="showTip(event, 'fs95', 326)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 327)" onmouseover="showTip(event, 'fs95', 327)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 328)" onmouseover="showTip(event, 'fs45', 328)" class="f">Pop</span> ()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 329)" onmouseover="showTip(event, 'fs95', 329)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 330)" onmouseover="showTip(event, 'fs95', 330)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs45', 331)" onmouseover="showTip(event, 'fs45', 331)" class="f">Pop</span> ()
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs95', 332)" onmouseover="showTip(event, 'fs95', 332)" class="i">t</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 333)" onmouseover="showTip(event, 'fs95', 333)" class="i">t</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 334)" onmouseover="showTip(event, 'fs43', 334)" class="f">PushChild</span> (<span onmouseout="hideTip(event, 'fs7', 335)" onmouseover="showTip(event, 'fs7', 335)" class="p">Id</span> <span class="s">&quot;d&quot;</span>, <span onmouseout="hideTip(event, 'fs96', 336)" onmouseover="showTip(event, 'fs96', 336)" class="p">None</span>)
</code></pre></td>
</tr>
</table>
<p>At this point, we have represented the building of a nested structure in an idiomatic manner, but the internal representation is simply a list of operations describing the building of the structure, rather than the structure itself.</p>
<p>We can then create the tree structure - with bi-directional links - at a fixed point in time, allowing us to traverse the tree.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs97', 337)" onmouseover="showTip(event, 'fs97', 337)" class="i">tc</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs95', 338)" onmouseover="showTip(event, 'fs95', 338)" class="i">t</span><span class="o">.</span><span class="i">Build</span> ()
</code></pre></td>
</tr>
</table>
<p>Now let's write a function to process each node as we encounter it in the traversal.</p>
<p>The signature of this function matches the signature used by a folding function, which allows us to fold over the list of visit operations and build up a composite value.</p>
<p>In our case, we want to build up a string containing a textual representation of the path in the traversal.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs98', 339)" onmouseover="showTip(event, 'fs98', 339)" class="f">printNode</span> <span onmouseout="hideTip(event, 'fs99', 340)" onmouseover="showTip(event, 'fs99', 340)" class="i">res</span> <span onmouseout="hideTip(event, 'fs100', 341)" onmouseover="showTip(event, 'fs100', 341)" class="i">curr</span> <span class="o">=</span> 
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs101', 342)" onmouseover="showTip(event, 'fs101', 342)" class="i">nodeString</span> <span class="o">=</span> <span class="k">match</span> <span onmouseout="hideTip(event, 'fs100', 343)" onmouseover="showTip(event, 'fs100', 343)" class="i">curr</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs77', 344)" onmouseover="showTip(event, 'fs77', 344)" class="p">ReadValue</span> (<span onmouseout="hideTip(event, 'fs23', 345)" onmouseover="showTip(event, 'fs23', 345)" class="i">id</span>, <span onmouseout="hideTip(event, 'fs102', 346)" onmouseover="showTip(event, 'fs102', 346)" class="i">vo</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs37', 347)" onmouseover="showTip(event, 'fs37', 347)" class="f">sprintf</span> <span class="s">&quot;</span><span class="pf">%s</span><span class="s"></span><span class="pf">%s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs23', 348)" onmouseover="showTip(event, 'fs23', 348)" class="i">id</span><span class="o">.</span><span class="i">unapply</span> (<span onmouseout="hideTip(event, 'fs102', 349)" onmouseover="showTip(event, 'fs102', 349)" class="i">vo</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs35', 350)" onmouseover="showTip(event, 'fs35', 350)" class="t">Option</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs36', 351)" onmouseover="showTip(event, 'fs36', 351)" class="f">map</span> (<span onmouseout="hideTip(event, 'fs37', 352)" onmouseover="showTip(event, 'fs37', 352)" class="f">sprintf</span> <span class="s">&quot; (</span><span class="pf">%A</span><span class="s">)&quot;</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs35', 353)" onmouseover="showTip(event, 'fs35', 353)" class="i">Option</span><span class="o">.</span><span class="i">defaultValue</span> <span class="s">&quot;&quot;</span>)
        | <span onmouseout="hideTip(event, 'fs75', 354)" onmouseover="showTip(event, 'fs75', 354)" class="p">VisitRoot</span> <span class="k">-&gt;</span> <span class="s">&quot;|&quot;</span>
        | <span onmouseout="hideTip(event, 'fs76', 355)" onmouseover="showTip(event, 'fs76', 355)" class="p">VisitChild</span> <span onmouseout="hideTip(event, 'fs23', 356)" onmouseover="showTip(event, 'fs23', 356)" class="i">id</span> <span class="k">-&gt;</span> <span class="s">&quot;↓&quot;</span>
        | <span onmouseout="hideTip(event, 'fs74', 357)" onmouseover="showTip(event, 'fs74', 357)" class="t">VisitOperation</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs78', 358)" onmouseover="showTip(event, 'fs78', 358)" class="p">Pop</span> <span class="k">-&gt;</span> <span class="s">&quot;↑&quot;</span>
        <span onmouseout="hideTip(event, 'fs37', 359)" onmouseover="showTip(event, 'fs37', 359)" class="f">sprintf</span> <span class="s">&quot;</span><span class="pf">%s</span><span class="s"> </span><span class="pf">%s</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs99', 360)" onmouseover="showTip(event, 'fs99', 360)" class="i">res</span> <span onmouseout="hideTip(event, 'fs101', 361)" onmouseover="showTip(event, 'fs101', 361)" class="i">nodeString</span>
</code></pre></td>
</tr>
</table>
<p>For a given visit operation, we compute a glyph describing the traversal ('up' and 'down' for <code>Pop</code> and <code>Push</code>), or the node's 'id' and 'value', and tack it at the end of the string which represents the path taken so far.</p>
<p>Finally, we pass the printing function to the visitor methods on the <code>TreeCursor</code> instance:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp">    <span onmouseout="hideTip(event, 'fs103', 362)" onmouseover="showTip(event, 'fs103', 362)" class="f">printfn</span> <span class="s">&quot;Path to root  : </span><span class="pf">%s</span><span class="s">&quot;</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs97', 363)" onmouseover="showTip(event, 'fs97', 363)" class="i">tc</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs75', 364)" onmouseover="showTip(event, 'fs75', 364)" class="i">VisitRoot</span>     <span onmouseout="hideTip(event, 'fs98', 365)" onmouseover="showTip(event, 'fs98', 365)" class="i">printNode</span> <span class="s">&quot;&quot;</span>
    <span onmouseout="hideTip(event, 'fs103', 366)" onmouseover="showTip(event, 'fs103', 366)" class="f">printfn</span> <span class="s">&quot;Pre-Order walk: </span><span class="pf">%s</span><span class="s">&quot;</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs97', 367)" onmouseover="showTip(event, 'fs97', 367)" class="i">tc</span><span class="o">.</span><span class="i">VisitPreOrder</span> <span onmouseout="hideTip(event, 'fs98', 368)" onmouseover="showTip(event, 'fs98', 368)" class="i">printNode</span> <span class="s">&quot;&quot;</span>
</code></pre></td>
</tr>
</table>
<h2>Conclusion</h2>
<p>This method of description and deferred interpretation is a very powerful technique in functional programming. In our case, it allowed us to separate out concerns between tree creation and tree traversal, and appropriate the benefits of immutability (for tree creation) and mutability (for traversals) without sacrificing cleanliness or readability. In fact, we have hoisted all the mechanics of traversal away from the user, and visiting the tree is reduced to simply providing a folding function.</p>
<p>The concept is well worth learning, as in other languages with higher-kinded types, a lot of mechanical work is lifted by these abstractions. For example, the IO monad in Haskell, and the Free Monad in Scala and Haskell both use and amplify this concept.</p>
<p>Keep typing!</p>

<div class="tip" id="fs1">type Tree&lt;&#39;a&gt; =<br />&#160;&#160;{Tag: &#39;a;<br />&#160;&#160;&#160;Children: Tree&lt;&#39;a&gt; list;}<br /><br />Full name: funwithtrees.Tree&lt;_&gt;</div>
<div class="tip" id="fs2">Tree.Tag: &#39;a</div>
<div class="tip" id="fs3">Tree.Children: Tree&lt;&#39;a&gt; list</div>
<div class="tip" id="fs4">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>
<div class="tip" id="fs5">Multiple items<br />module Tree<br /><br />from funwithtrees<br /><br />--------------------<br />type Tree&lt;&#39;a&gt; =<br />&#160;&#160;{Tag: &#39;a;<br />&#160;&#160;&#160;Children: Tree&lt;&#39;a&gt; list;}<br /><br />Full name: funwithtrees.Tree&lt;_&gt;</div>
<div class="tip" id="fs6">type NodeId = | Id of string<br /><br />Full name: funwithtrees.Tree.NodeId</div>
<div class="tip" id="fs7">union case NodeId.Id: string -&gt; NodeId</div>
<div class="tip" id="fs8">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs9">Multiple items<br />type AutoOpenAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; AutoOpenAttribute<br />&#160;&#160;new : path:string -&gt; AutoOpenAttribute<br />&#160;&#160;member Path : string<br /><br />Full name: Microsoft.FSharp.Core.AutoOpenAttribute<br /><br />--------------------<br />new : unit -&gt; AutoOpenAttribute<br />new : path:string -&gt; AutoOpenAttribute</div>
<div class="tip" id="fs10">Multiple items<br />type AbstractClassAttribute =<br />&#160;&#160;inherit Attribute<br />&#160;&#160;new : unit -&gt; AbstractClassAttribute<br /><br />Full name: Microsoft.FSharp.Core.AbstractClassAttribute<br /><br />--------------------<br />new : unit -&gt; AbstractClassAttribute</div>
<div class="tip" id="fs11">Multiple items<br />type internal NodeBase&lt;&#39;a&gt; =<br />&#160;&#160;new : unit -&gt; NodeBase&lt;&#39;a&gt;<br />&#160;&#160;abstract member Level : int<br />&#160;&#160;member Children : NodeBase&lt;&#39;a&gt; list<br />&#160;&#160;member private _children : NodeBase&lt;&#39;a&gt; list<br />&#160;&#160;member Children : NodeBase&lt;&#39;a&gt; list with set<br />&#160;&#160;member private _children : NodeBase&lt;&#39;a&gt; list with set<br /><br />Full name: funwithtrees.Tree.Node.NodeBase&lt;_&gt;<br /><br />--------------------<br />internal new : unit -&gt; NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs12">val set : elements:seq&lt;&#39;T&gt; -&gt; Set&lt;&#39;T&gt; (requires comparison)<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.set</div>
<div class="tip" id="fs13">val this : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs14">member internal NodeBase.Children : NodeBase&lt;&#39;a&gt; list with set<br /><br />Full name: funwithtrees.Tree.Node.NodeBase`1.Children</div>
<div class="tip" id="fs15">property NodeBase._children: NodeBase&lt;&#39;a&gt; list</div>
<div class="tip" id="fs16">val ns : NodeBase&lt;&#39;a&gt; list</div>
<div class="tip" id="fs17">abstract member internal NodeBase.Level : int<br /><br />Full name: funwithtrees.Tree.Node.NodeBase`1.Level</div>
<div class="tip" id="fs18">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs19">Multiple items<br />type internal Root&lt;&#39;a&gt; =<br />&#160;&#160;inherit NodeBase&lt;&#39;a&gt;<br />&#160;&#160;new : unit -&gt; Root&lt;&#39;a&gt;<br />&#160;&#160;override Level : int<br /><br />Full name: funwithtrees.Tree.Node.Root&lt;_&gt;<br /><br />--------------------<br />internal new : unit -&gt; Root&lt;&#39;a&gt;</div>
<div class="tip" id="fs20">val this : Root&lt;&#39;a&gt;</div>
<div class="tip" id="fs21">override internal Root.Level : int<br /><br />Full name: funwithtrees.Tree.Node.Root`1.Level</div>
<div class="tip" id="fs22">Multiple items<br />type internal Node&lt;&#39;a&gt; =<br />&#160;&#160;inherit NodeBase&lt;&#39;a&gt;<br />&#160;&#160;new : id:NodeId * value:&#39;a option * parent:NodeBase&lt;&#39;a&gt; -&gt; Node&lt;&#39;a&gt;<br />&#160;&#160;override ToString : unit -&gt; string<br />&#160;&#160;member Id : NodeId<br />&#160;&#160;override Level : int<br />&#160;&#160;member Parent : NodeBase&lt;&#39;a&gt;<br />&#160;&#160;member Value : &#39;a option<br />&#160;&#160;member Value : &#39;a option with set<br /><br />Full name: funwithtrees.Tree.Node.Node&lt;_&gt;<br /><br />--------------------<br />internal new : id:NodeId * value:&#39;a option * parent:NodeBase&lt;&#39;a&gt; -&gt; Node&lt;&#39;a&gt;</div>
<div class="tip" id="fs23">val id : NodeId</div>
<div class="tip" id="fs24">val value : &#39;a option</div>
<div class="tip" id="fs25">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>
<div class="tip" id="fs26">val parent : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs27">val this : Node&lt;&#39;a&gt;</div>
<div class="tip" id="fs28">member internal Node.Id : NodeId<br /><br />Full name: funwithtrees.Tree.Node.Node`1.Id</div>
<div class="tip" id="fs29">member internal Node.Parent : NodeBase&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Node.Node`1.Parent</div>
<div class="tip" id="fs30">override internal Node.Level : int<br /><br />Full name: funwithtrees.Tree.Node.Node`1.Level</div>
<div class="tip" id="fs31">property NodeBase.Level: int</div>
<div class="tip" id="fs32">override internal Node.ToString : unit -&gt; string<br /><br />Full name: funwithtrees.Tree.Node.Node`1.ToString</div>
<div class="tip" id="fs33">val value : obj</div>
<div class="tip" id="fs34">property Node.Value: &#39;a option</div>
<div class="tip" id="fs35">module Option<br /><br />from Microsoft.FSharp.Core</div>
<div class="tip" id="fs36">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; option:&#39;T option -&gt; &#39;U option<br /><br />Full name: Microsoft.FSharp.Core.Option.map</div>
<div class="tip" id="fs37">val sprintf : format:Printf.StringFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.sprintf</div>
<div class="tip" id="fs38">Multiple items<br />type Tree&lt;&#39;a&gt; =<br />&#160;&#160;new : unit -&gt; Tree&lt;&#39;a&gt;<br />&#160;&#160;member AddSibling : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br />&#160;&#160;member ModifyValue : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br />&#160;&#160;member Pop : ?x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br />&#160;&#160;member PushChild : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br />&#160;&#160;member private Root : Root&lt;&#39;a&gt;<br />&#160;&#160;member private ops : obj list<br />&#160;&#160;member private ops : obj list with set<br /><br />Full name: funwithtrees.Tree.Tree&lt;_&gt;<br /><br />--------------------<br />new : unit -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs39">val root : Root&lt;&#39;a&gt;</div>
<div class="tip" id="fs40">val this : Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs41">Multiple items<br />member private Tree.Root : Root&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Tree`1.Root<br /><br />--------------------<br />type internal Root&lt;&#39;a&gt; =<br />&#160;&#160;inherit NodeBase&lt;&#39;a&gt;<br />&#160;&#160;new : unit -&gt; Root&lt;&#39;a&gt;<br />&#160;&#160;override Level : int<br /><br />Full name: funwithtrees.Tree.Node.Root&lt;_&gt;<br /><br />--------------------<br />internal new : unit -&gt; Root&lt;&#39;a&gt;</div>
<div class="tip" id="fs42">member Tree.ModifyValue : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs43">member Tree.PushChild : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs44">member Tree.AddSibling : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs45">member Tree.Pop : ?x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;</div>
<div class="tip" id="fs46">member Tree.PushChild : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Tree`1.PushChild</div>
<div class="tip" id="fs47">val x : &#39;a</div>
<div class="tip" id="fs48">property Tree.ops: obj list</div>
<div class="tip" id="fs49">member Tree.AddSibling : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Tree`1.AddSibling</div>
<div class="tip" id="fs50">member Tree.ModifyValue : x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Tree`1.ModifyValue</div>
<div class="tip" id="fs51">member Tree.Pop : ?x:&#39;a0 -&gt; Tree&lt;&#39;a&gt;<br /><br />Full name: funwithtrees.Tree.Tree`1.Pop</div>
<div class="tip" id="fs52">val x : &#39;a option</div>
<div class="tip" id="fs53">val applyOp : op:&#39;a -&gt; node:NodeBase&lt;&#39;a0&gt; -&gt; NodeBase&lt;&#39;a0&gt;<br /><br />Full name: funwithtrees.Tree.applyOp</div>
<div class="tip" id="fs54">val op : &#39;a</div>
<div class="tip" id="fs55">val node : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs56">Multiple items<br />module Node<br /><br />from funwithtrees.Tree<br /><br />--------------------<br />type internal Node&lt;&#39;a&gt; =<br />&#160;&#160;inherit NodeBase&lt;&#39;a&gt;<br />&#160;&#160;new : id:NodeId * value:&#39;a option * parent:NodeBase&lt;&#39;a&gt; -&gt; Node&lt;&#39;a&gt;<br />&#160;&#160;override ToString : unit -&gt; string<br />&#160;&#160;member Id : NodeId<br />&#160;&#160;override Level : int<br />&#160;&#160;member Parent : NodeBase&lt;&#39;a&gt;<br />&#160;&#160;member Value : &#39;a option<br />&#160;&#160;member Value : &#39;a option with set<br /><br />Full name: funwithtrees.Tree.Node.Node&lt;_&gt;<br /><br />--------------------<br />internal new : id:NodeId * value:&#39;a option * parent:NodeBase&lt;&#39;a&gt; -&gt; Node&lt;&#39;a&gt;</div>
<div class="tip" id="fs57">property NodeBase.Children: NodeBase&lt;&#39;a&gt; list</div>
<div class="tip" id="fs58">val failwith : message:string -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.Operators.failwith</div>
<div class="tip" id="fs59">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs60">val current : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs61">Multiple items<br />module List<br /><br />from Microsoft.FSharp.Collections<br /><br />--------------------<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;| ( [] )<br />&#160;&#160;| ( :: ) of Head: &#39;T * Tail: &#39;T list<br />&#160;&#160;interface IEnumerable<br />&#160;&#160;interface IEnumerable&lt;&#39;T&gt;<br />&#160;&#160;member GetSlice : startIndex:int option * endIndex:int option -&gt; &#39;T list<br />&#160;&#160;member Head : &#39;T<br />&#160;&#160;member IsEmpty : bool<br />&#160;&#160;member Item : index:int -&gt; &#39;T with get<br />&#160;&#160;member Length : int<br />&#160;&#160;member Tail : &#39;T list<br />&#160;&#160;static member Cons : head:&#39;T * tail:&#39;T list -&gt; &#39;T list<br />&#160;&#160;static member Empty : &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List&lt;_&gt;</div>
<div class="tip" id="fs62">val foldBack : folder:(&#39;T -&gt; &#39;State -&gt; &#39;State) -&gt; list:&#39;T list -&gt; state:&#39;State -&gt; &#39;State<br /><br />Full name: Microsoft.FSharp.Collections.List.foldBack</div>
<div class="tip" id="fs63">val visitRoot : (NodeBase&lt;&#39;a&gt; -&gt; seq&lt;NodeBase&lt;&#39;a&gt;&gt;)</div>
<div class="tip" id="fs64">val start : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs65">val visit : (NodeBase&lt;&#39;a&gt; -&gt; seq&lt;NodeBase&lt;&#39;a&gt;&gt;)</div>
<div class="tip" id="fs66">val n : Node&lt;&#39;a&gt;</div>
<div class="tip" id="fs67">Multiple items<br />val seq : sequence:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = System.Collections.Generic.IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;</div>
<div class="tip" id="fs68">property Node.Parent: NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs69">val r : Root&lt;&#39;a&gt;</div>
<div class="tip" id="fs70">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs71">val empty&lt;&#39;T&gt; : seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.empty</div>
<div class="tip" id="fs72">val last : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs73">val last : source:seq&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Collections.Seq.last</div>
<div class="tip" id="fs74">type VisitOperation&lt;&#39;a&gt; =<br />&#160;&#160;| VisitRoot<br />&#160;&#160;| VisitChild of NodeId<br />&#160;&#160;| ReadValue of NodeId * &#39;a option<br />&#160;&#160;| Pop<br /><br />Full name: funwithtrees.Tree.VisitOperation&lt;_&gt;</div>
<div class="tip" id="fs75">union case VisitOperation.VisitRoot: VisitOperation&lt;&#39;a&gt;</div>
<div class="tip" id="fs76">union case VisitOperation.VisitChild: NodeId -&gt; VisitOperation&lt;&#39;a&gt;</div>
<div class="tip" id="fs77">union case VisitOperation.ReadValue: NodeId * &#39;a option -&gt; VisitOperation&lt;&#39;a&gt;</div>
<div class="tip" id="fs78">union case VisitOperation.Pop: VisitOperation&lt;&#39;a&gt;</div>
<div class="tip" id="fs79">Multiple items<br />type TreeCursor&lt;&#39;a&gt; =<br />&#160;&#160;internal new : ops:obj -&gt; TreeCursor&lt;&#39;a&gt;<br />&#160;&#160;member PathToRoot : seq&lt;VisitOperation&lt;&#39;a&gt;&gt;<br />&#160;&#160;member PreOrderPath : seq&lt;VisitOperation&lt;&#39;a&gt;&gt;<br /><br />Full name: funwithtrees.Tree.TreeCursor&lt;_&gt;<br /><br />--------------------<br />internal new : ops:obj -&gt; TreeCursor&lt;&#39;a&gt;</div>
<div class="tip" id="fs80">val ops : obj</div>
<div class="tip" id="fs81">val this : TreeCursor&lt;&#39;a&gt;</div>
<div class="tip" id="fs82">member TreeCursor.PathToRoot : seq&lt;VisitOperation&lt;&#39;a&gt;&gt;<br /><br />Full name: funwithtrees.Tree.TreeCursor`1.PathToRoot</div>
<div class="tip" id="fs83">val readValue : (NodeBase&lt;&#39;a&gt; -&gt; VisitOperation&lt;&#39;a&gt;)</div>
<div class="tip" id="fs84">val nb : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs85">property Node.Id: NodeId</div>
<div class="tip" id="fs86">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs87">member TreeCursor.PreOrderPath : seq&lt;VisitOperation&lt;&#39;a&gt;&gt;<br /><br />Full name: funwithtrees.Tree.TreeCursor`1.PreOrderPath</div>
<div class="tip" id="fs88">val visit : (NodeBase&lt;&#39;a&gt; -&gt; seq&lt;VisitOperation&lt;&#39;a&gt;&gt;)</div>
<div class="tip" id="fs89">val child : NodeBase&lt;&#39;a&gt;</div>
<div class="tip" id="fs90">val rev : list:&#39;T list -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.List.rev</div>
<div class="tip" id="fs91">val c : Node&lt;&#39;a&gt;</div>
<div class="tip" id="fs92">val fold : folder:(&#39;State -&gt; &#39;T -&gt; &#39;State) -&gt; state:&#39;State -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;State<br /><br />Full name: Microsoft.FSharp.Collections.Seq.fold</div>
<div class="tip" id="fs93">property TreeCursor.PathToRoot: seq&lt;VisitOperation&lt;&#39;a&gt;&gt;</div>
<div class="tip" id="fs94">property TreeCursor.PreOrderPath: seq&lt;VisitOperation&lt;&#39;a&gt;&gt;</div>
<div class="tip" id="fs95">val t : Tree&lt;string&gt;<br /><br />Full name: funwithtrees.Tree.t</div>
<div class="tip" id="fs96">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs97">val tc : obj<br /><br />Full name: funwithtrees.Tree.tc</div>
<div class="tip" id="fs98">val printNode : res:string -&gt; curr:VisitOperation&lt;&#39;a&gt; -&gt; string<br /><br />Full name: funwithtrees.Tree.printNode</div>
<div class="tip" id="fs99">val res : string</div>
<div class="tip" id="fs100">val curr : VisitOperation&lt;&#39;a&gt;</div>
<div class="tip" id="fs101">val nodeString : string</div>
<div class="tip" id="fs102">val vo : &#39;a option</div>
<div class="tip" id="fs103">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>

        </section>

        <footer class="post-footer">

            

            <section class="author">
                <h4><a href="#">&nbsp;</a></h4>

                
                <div class="author-meta">
                    
                </div>
            </section>

            

        </footer>

    </article>
</main>




        <footer class="site-footer clearfix">
            <section class="copyright"><a href="https://johnazariah.github.io/">John Azariah's Blog</a> &copy; 2018</section>
            <section class="poweredby">Proudly published with <a href="https://github.com/fsprojects/FsBlog">FsBlog</a></section>
        </footer>

    </div>

    

    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="https://johnazariah.github.io//js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://johnazariah.github.io//js/index.js"></script>

</body>
</html>
